# 三次握手

> 三次握手就是建立一个 TCP 连接时，需要客户端和服务器发送三个包
> 三次握手的目的是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换 TCP 窗口大小信息。在 socket 编程中，客户端执行 connect() 时。将触发三次握手。

- 过程

  1. 第一次握手,客户端将 TCP 报文标志位 SYN 置 1，随机产生一个序号值 seq=j,保存在 TCP 首部的序列号字段中，指明客户端打算连接的服务器的端口号，并将该数据包发送给服务器端,发送完毕，客户端进入 SYN_SENT 状态

  2. 第二次握手,服务器收到数据包后有标志位 SYN=1，知道客户端要请求建立连接，服务器将 TCP 报文的标志位 SYN 和 ACK 都置为 1，ack = j+1 seq=k，并将数据包发送给客户端以确认请求，服务器进入 SYN_RCVD 状态

  3. 第三次握手,客户端确认确认后，检查 ack 是否为 j+1，如果是确认则将标志位 ACK 置为 1，ack= k+1，并将该数据包发送给服务器，服务器检查 ack 是否为 k+1，ACK 是否为 1，如果正确则建立连接成功，客户端和服务器进入 ESTABLISHED 转态，完成三次握手，然后开始传输数据

  ack 是头部确认号 Acknowledge number 缩写 ack，是对上一个包的序列号进行确认 ack = seq + 1
  大写的 ACK，则是我们上面说的 TCP 首部的标志位，用于标志的 TCP 包是否对上一个包进行了确认操作，如果确认了，则把 ACK 标志位设置成 1。

  SYN: 同步标志位，用于建立回话连接，同步序列号
  ACK：确认标志位，对已接受的数据包进行确认
  FIN: 完成标志位，表示没有数据要发了，即将关闭连接
  PSH: 推送标志位，表示该数据被对方接受后应立即上交到应用层，不应该在缓存区
  RST：重置标志位，重置标志位，用于连复位，拒绝错误和非法的数据包
  URG: 紧急标志位，表示数据包的紧急指针域有效，用来保证连接不被阻断，并督促中间设备尽快处理；

# 四次挥手

> 四次挥手是终止 TCP 连接，就是断开一个 TCP 连接时，需要客户端和服务器端总共发送四个包来确认断开连接，。在 socket 编程中，这一过程由客户端或者服务器任意一端来执行 close 触发

> 由于 TCP 连接时全双工，因此每个方向都行必须单独进行关闭

- 过程(假设是客户端发起的):

  1. 第一挥手: c 端发起挥手，向服务端发送标志位为 FIN 的报文，设置序列号为 seq，此时客户端进入 FIN_WAIT_1 转态
  2. 第二次挥手：serve 端收到 FIN 报文，向客户端发送 ACK 标志位的报文 ack 为 seq+1，客户端接手后进入 FIN_WAIT_2 状态，
  3. 第三次挥手：服务器向客户端发送 FIN 报文，请求关闭连接，客户端接手后进入 LAST_ACK 状态
  4. 客户端接受 FIN 报文，向服务器发送 ACK 报文，然后客户端进入 TIME_ACK 状态，服务器接收到 ACK 报文就关闭连接，客户端等待 2MSL 时间依然没有收到回复，证明服务器关闭正常，然后客户端关闭连接

## 为什么等待 2MSL

> MSL：报文端最大生存时间，它是任何报文段被丢弃前在网络内的最长时间。

1. 保证 TCP 协议的全双工连接能够可靠关闭
2. 保证这次连接的重复数据段从网络中消失
